name: Snowflake ML Pipeline via REST API

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  trigger-ml-pipeline:
    runs-on: ubuntu-latest

    env:
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}          # e.g. vy23825.central-india.azure
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Trigger Snowflake Tasks via REST API
        run: |
          echo "Triggering Snowflake ML pipeline through REST API..."

          SNOWFLAKE_HOST="${SNOWFLAKE_ACCOUNT}.snowflakecomputing.com"
          AUTH=$(echo -n "${SNOWFLAKE_USER}:${SNOWFLAKE_PASSWORD}" | base64)

          SQL_QUERY="EXECUTE TASK TASK_1_DATA_INGESTION;
                     EXECUTE TASK TASK_2_FEATURE_ENGINEERING;
                     EXECUTE TASK TASK_3_MODEL_TRAINING;
                     EXECUTE TASK TASK_4_MODEL_EVALUATION;"

          echo "Running tasks using REST API..."
          RESPONSE=$(curl -s -X POST "https://${SNOWFLAKE_HOST}/api/v2/statements" \
            -H "Authorization: Basic ${AUTH}" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d "{
                  \"statement\": \"${SQL_QUERY}\",
                  \"warehouse\": \"${SNOWFLAKE_WAREHOUSE}\",
                  \"database\": \"${SNOWFLAKE_DATABASE}\",
                  \"schema\": \"${SNOWFLAKE_SCHEMA}\",
                  \"role\": \"${SNOWFLAKE_ROLE}\"
                }")

          echo "Snowflake API Response:"
          echo "${RESPONSE}" | jq '.'

          STATEMENT_HANDLE=$(echo "$RESPONSE" | jq -r '.statementHandle')

          if [ "$STATEMENT_HANDLE" = "null" ] || [ -z "$STATEMENT_HANDLE" ]; then
            echo "Error: Failed to trigger Snowflake task."
            exit 1
          fi

          echo "Statement handle: $STATEMENT_HANDLE"

      - name: Wait for task completion
        run: |
          echo "Waiting for 60 seconds before fetching results..."
          sleep 60

      - name: Check task execution status
        run: |
          SNOWFLAKE_HOST="${SNOWFLAKE_ACCOUNT}.snowflakecomputing.com"
          AUTH=$(echo -n "${SNOWFLAKE_USER}:${SNOWFLAKE_PASSWORD}" | base64)

          echo "Checking statement status..."
          STATUS_RESPONSE=$(curl -s -X GET "https://${SNOWFLAKE_HOST}/api/v2/statements/${STATEMENT_HANDLE}" \
            -H "Authorization: Basic ${AUTH}" \
            -H "Accept: application/json")

          echo "Snowflake Status Response:"
          echo "$STATUS_RESPONSE" | jq '.'

      - name: Fetch model files from Snowflake stage (manual)
        run: |
          echo "To download model artifacts (e.g. power_model.joblib.gz),"
          echo "use presigned Snowflake stage URLs or COPY INTO commands."
          echo "Snowflake REST API currently does not support GET file directly."
