name: Snowflake CLI MLOps Pipeline (Final Stable Version)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  snowflake-pipeline:
    runs-on: ubuntu-22.04   # ‚úÖ Stable version for SnowSQL installer

    env:
      SNOWSQL_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWSQL_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWSQL_PWD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWSQL_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWSQL_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWSQL_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWSQL_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ‚úÖ Step 1: Install SnowSQL CLI using official Snowflake bootstrap installer
      - name: Install SnowSQL CLI (official method)
        run: |
          echo "üöÄ Downloading SnowSQL bootstrap installer..."
          mkdir -p $HOME/snowsql_install
          cd $HOME/snowsql_install
          
          # Download the official bootstrap installer (works on CI/CD)
          curl -L -o snowsql_install.bash https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.29-linux_x86_64.bash
          
          echo "üîß Installing SnowSQL non-interactively..."
          bash snowsql_install.bash -y -d $HOME/snowsql_install -p $HOME/snowsql_install/bin
          
          export PATH="$HOME/snowsql_install/bin:$PATH"
          echo "‚úÖ SnowSQL version:"
          snowsql -v

      # ‚úÖ Step 2: Trigger Snowflake ML pipeline tasks
      - name: Trigger ML Pipeline
        run: |
          export PATH="$HOME/snowsql_install/bin:$PATH"
          echo "üöÄ Triggering Snowflake ML pipeline..."
          snowsql \
            -a $SNOWSQL_ACCOUNT \
            -u $SNOWSQL_USER \
            -p $SNOWSQL_PWD \
            -r $SNOWSQL_ROLE \
            -w $SNOWSQL_WAREHOUSE \
            -d $SNOWSQL_DATABASE \
            -s $SNOWSQL_SCHEMA \
            -q "
              EXECUTE TASK TASK_1_DATA_INGESTION;
              EXECUTE TASK TASK_2_FEATURE_ENGINEERING;
              EXECUTE TASK TASK_3_MODEL_TRAINING;
              EXECUTE TASK TASK_4_MODEL_EVALUATION;
            "
          echo "‚úÖ ML pipeline triggered successfully."

      # ‚úÖ Step 3: Wait for Snowflake tasks to complete
      - name: Wait briefly for pipeline completion
        run: |
          echo "‚è≥ Waiting for 60 seconds to let Snowflake tasks complete..."
          sleep 60

      # ‚úÖ Step 4: Fetch model and artifacts from Snowflake stage
      - name: Fetch Model Files
        run: |
          export PATH="$HOME/snowsql_install/bin:$PATH"
          mkdir -p downloads
          echo "‚¨áÔ∏è Fetching model files from Snowflake..."
          snowsql \
            -a $SNOWSQL_ACCOUNT \
            -u $SNOWSQL_USER \
            -p $SNOWSQL_PWD \
            -r $SNOWSQL_ROLE \
            -w $SNOWSQL_WAREHOUSE \
            -d $SNOWSQL_DATABASE \
            -s $SNOWSQL_SCHEMA \
            -q "
              GET @ML_MODELS_STAGE/power_model.joblib.gz file://downloads/;
              GET @ML_MODELS_STAGE/prediction_vs_actuals.png file://downloads/;
            "
          echo "‚úÖ Model files downloaded successfully."

      # ‚úÖ Step 5: Verify downloaded files
      - name: Verify Files
        run: |
          echo "üìÇ Listing downloads..."
          ls -lh downloads/
          if [ ! -f downloads/power_model.joblib.gz ]; then
            echo "‚ùå Model file missing!"; exit 1; fi
          if [ ! -f downloads/prediction_vs_actuals.png ]; then
            echo "‚ùå Plot file missing!"; exit 1; fi
          echo "‚úÖ Files verified successfully."

      # ‚úÖ Step 6: Upload artifacts to GitHub
      - name: Upload Model Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: snowflake-ml-artifacts
          path: downloads/

