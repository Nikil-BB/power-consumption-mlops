name: Deploy and Download ML Artifacts

on:
  push:
    branches:
      - main   # runs whenever you push to main branch

jobs:
  deploy:
    runs-on: ubuntu-22.04   # âœ… use Ubuntu 22.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ðŸ‘‰ Replace this with your actual deployment steps
      - name: Deploy application
        run: |
          echo "Deploying application..."
          # e.g., docker build, push to ECR, deploy to EC2/Lambda

  download-artifacts:
    runs-on: ubuntu-22.04   # âœ… SnowSQL repo supports Ubuntu 22.04
    needs: deploy   # âœ… only runs after deploy succeeds
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install SnowSQL (from Snowflake repo for Ubuntu 22.04)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip apt-transport-https gnupg
          curl -s https://sfc-repo.snowflakecomputing.com/apt/snowflake.asc | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/snowflake.gpg > /dev/null
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/snowflake.gpg] https://sfc-repo.snowflakecomputing.com/apt/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/snowflake.list
          sudo apt-get update
          sudo apt-get install -y snowsql

      - name: Verify SnowSQL Installation
        run: snowsql --version

      - name: Download ML Artifacts from Snowflake
        env:
          SNOWSQL_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWSQL_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWSQL_PWD: ${{ secrets.SNOWFLAKE_PWD }}
          SNOWSQL_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWSQL_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWSQL_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWSQL_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
        run: |
          snowsql -a $SNOWSQL_ACCOUNT \
                  -u $SNOWSQL_USER \
                  -p $SNOWSQL_PWD \
                  -r $SNOWSQL_ROLE \
                  -w $SNOWSQL_WAREHOUSE \
                  -d $SNOWSQL_DATABASE \
                  -s $SNOWSQL_SCHEMA \
                  -q "GET @ML_MODELS_STAGE/* file://$GITHUB_WORKSPACE/"

      - name: Upload ML Artifacts to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: ml_artifacts
          path: |
            power_model.joblib.gz
            prediction_vs_actuals.png
