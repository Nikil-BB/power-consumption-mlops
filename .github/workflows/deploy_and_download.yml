name: Fetch Model from Snowflake (CLI Only - Fixed Installer)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  fetch-model:
    runs-on: ubuntu-latest
    env:
      SNOWSQL_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}    # e.g. vy23825.central-india.azure
      SNOWSQL_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWSQL_PWD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWSQL_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWSQL_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWSQL_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWSQL_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ‚úÖ Correct SnowSQL installation for Ubuntu runners
      - name: Install SnowSQL CLI
        run: |
          echo "üöÄ Downloading and installing SnowSQL..."
          curl -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.29-linux_x86_64.bash
          bash snowsql-1.2.29-linux_x86_64.bash -y
          export PATH=$HOME/bin:$PATH
          snowsql -v

      - name: Fetch model and plot from Snowflake stage
        run: |
          mkdir -p downloads
          export PATH=$HOME/bin:$PATH
          echo "‚¨áÔ∏è Fetching files from Snowflake..."
          snowsql \
            -a $SNOWSQL_ACCOUNT \
            -u $SNOWSQL_USER \
            -p $SNOWSQL_PWD \
            -r $SNOWSQL_ROLE \
            -w $SNOWSQL_WAREHOUSE \
            -d $SNOWSQL_DATABASE \
            -s $SNOWSQL_SCHEMA \
            -q "GET @ML_MODELS_STAGE/power_model.joblib.gz file://$GITHUB_WORKSPACE/downloads/;"
          snowsql \
            -a $SNOWSQL_ACCOUNT \
            -u $SNOWSQL_USER \
            -p $SNOWSQL_PWD \
            -r $SNOWSQL_ROLE \
            -w $SNOWSQL_WAREHOUSE \
            -d $SNOWSQL_DATABASE \
            -s $SNOWSQL_SCHEMA \
            -q "GET @ML_MODELS_STAGE/prediction_vs_actuals.png file://$GITHUB_WORKSPACE/downloads/;"
          echo "‚úÖ Model and plot downloaded successfully to ./downloads/"

      - name: Upload artifacts (model + plot)
        uses: actions/upload-artifact@v4
        with:
          name: ml-model-and-plot
          path: downloads/
